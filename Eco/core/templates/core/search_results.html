{% extends "base.html" %}
{% block title %}Search — EcoInsight{% endblock %}

{% block content %}
  <div style="max-width:980px;margin:22px auto;padding:8px;">
    <h2>
      {% if query %}
        Search results for “{{ query }}”
      {% else %}
        Search
      {% endif %}
    </h2>

    <div style="margin-bottom:12px;color:var(--muted);font-size:14px;">
      {% if selected_category %}
        <strong>Category:</strong> {{ selected_category }} &nbsp;
      {% endif %}
      {% if selected_tag %}
        <strong>Tag:</strong> {{ selected_tag }} &nbsp;
      {% endif %}
      {% if selected_author %}
        <strong>Author:</strong>
        {% if filter_authors %}
          {% for id, username in filter_authors %}
            {% if id|stringformat:"s" == selected_author %}
              {{ username }}
            {% endif %}
          {% endfor %}
        {% else %}
          {{ selected_author }}
        {% endif %}
      {% endif %}

      {# Replace the parentheses check with explicit negative checks #}
      {% if not selected_author and not selected_tag and not selected_category %}
        <span class="kv">No filters applied</span>
      {% endif %}
    </div>

    {% if page_obj and page_obj.object_list %}
      <ul class="results" style="list-style:none;padding:0;margin:0;">
        {% for article in page_obj %}
          <li style="margin-bottom:18px;padding:12px;border-radius:8px;border:1px solid #eef2f5;">
            <a href="{% url 'article_detail' slug=article.slug %}" style="font-weight:700;font-size:16px;">
              {{ article.title }}
            </a>
            <div style="color:var(--muted);font-size:13px;margin-top:6px;">
              {{ article.publish_date|date:"M j, Y" }} • {{ article.author }}
            </div>
            {% if article.summary %}
              <p style="margin-top:8px;color:#334155;">{{ article.summary|truncatechars:200 }}</p>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <div class="pagination" style="margin-top:18px;text-align:center;">
        {# Use explicit variable assignments in one-line 'with' (no parentheses) #}
        {% with q_q=query|urlencode q_author=selected_author|urlencode q_tag=selected_tag|urlencode q_cat=selected_category|urlencode %}
          {% if page_obj.has_previous %}
            <a class="btn-ghost" href="?q={{ q_q }}&author={{ q_author }}&tag={{ q_tag }}&category={{ q_cat }}&page={{ page_obj.previous_page_number }}">Previous</a>
          {% endif %}

          <span style="margin:0 12px;color:var(--muted)">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="btn-ghost" href="?q={{ q_q }}&author={{ q_author }}&tag={{ q_tag }}&category={{ q_cat }}&page={{ page_obj.next_page_number }}">Next</a>
          {% endif %}
        {% endwith %}
      </div>

    {% else %}
      {% if query or selected_author or selected_tag or selected_category %}
        <p>No results found for your query and filters.</p>
      {% else %}
        <p>Enter a search query or choose filters to find articles.</p>
      {% endif %}
    {% endif %}
  </div>
{% endblock %}
